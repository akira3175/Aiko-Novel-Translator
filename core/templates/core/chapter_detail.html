{% extends "core/base.html" %}

{% block title %}{{ chapter.title_translation|default:chapter.title }}{% endblock %}

{% block extra_css %}
<style>
    .breadcrumb {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        color: var(--text-light);
        font-size: 0.9rem;
        flex-wrap: wrap;
    }
    
    .breadcrumb a {
        color: var(--primary);
        text-decoration: none;
    }
    
    .chapter-header {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        border-left: 4px solid var(--primary);
    }
    
    .chapter-title {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1rem;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    /* Translation Style Section */
    .translation-style-section {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .style-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .style-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .style-content {
        background: var(--light);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid var(--border);
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.6;
        color: var(--text);
        font-size: 0.95rem;
    }
    
    .style-content.empty {
        color: var(--text-light);
        font-style: italic;
    }
    
    .style-editor {
        display: none;
    }
    
    .style-editor.show {
        display: block;
    }
    
    .style-textarea {
        width: 100%;
        min-height: 150px;
        padding: 1rem;
        border: 2px solid var(--border);
        border-radius: 8px;
        font-size: 0.95rem;
        font-family: inherit;
        line-height: 1.6;
        resize: vertical;
    }
    
    .style-textarea:focus {
        outline: none;
        border-color: var(--primary);
    }
    
    .style-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }
    
    .style-examples {
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(99, 102, 241, 0.05);
        border-radius: 8px;
        border-left: 3px solid var(--primary);
    }
    
    .style-examples-title {
        font-weight: 600;
        color: var(--dark);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .style-example {
        font-size: 0.85rem;
        color: var(--text-light);
        line-height: 1.6;
        margin-top: 0.25rem;
    }
    
    /* Foreign character warning styles */
    .foreign-warning {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.1));
        border: 2px solid #ef4444;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .foreign-warning-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1rem;
    }
    
    .foreign-warning-icon {
        font-size: 2rem;
    }
    
    .foreign-warning-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #991b1b;
    }
    
    .foreign-warning-content {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        white-space: pre-line;
        line-height: 1.8;
        color: #374151;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
    }
    
    .retranslate-hint {
        margin-top: 1rem;
        padding: 0.75rem;
        background: #fef3c7;
        border-radius: 8px;
        color: #92400e;
        font-size: 0.9rem;
    }
    
    .progress-section {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .progress-bar {
        width: 100%;
        height: 30px;
        background: var(--light);
        border-radius: 15px;
        overflow: hidden;
        position: relative;
        margin: 1rem 0;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #10b981, #059669);
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 0.9rem;
    }
    
    .progress-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 0.75rem;
    }
    
    .stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.25rem;
    }
    
    .stat-label {
        font-size: 0.8rem;
        color: var(--text-light);
    }
    
    .stat-value {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--primary);
    }
    
    .quality-score {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .score-display {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }
    
    .score-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
    }
    
    .score-high {
        background: linear-gradient(135deg, #10b981, #059669);
    }
    
    .score-medium {
        background: linear-gradient(135deg, #f59e0b, #d97706);
    }
    
    .score-low {
        background: linear-gradient(135deg, #ef4444, #dc2626);
    }
    
    .segments-section {
        margin-top: 2rem;
    }
    
    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--dark);
        margin-bottom: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .segment-card {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        transition: all 0.3s;
    }
    
    .segment-card:hover {
        border-color: var(--primary);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
    }
    
    .segment-card[data-has-warning="true"] {
        border-left: 4px solid #ef4444;
    }
    
    .segment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid var(--light);
    }
    
    .segment-title {
        font-weight: 700;
        color: var(--dark);
        font-size: 1.1rem;
    }
    
    .badges {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .badge {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
    
    .badge-success {
        background: #d1fae5;
        color: #065f46;
    }
    
    .badge-pending {
        background: #e5e7eb;
        color: #374151;
    }
    
    .badge-score {
        background: #fef3c7;
        color: #92400e;
    }
    
    .badge-warning {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .content-block {
        margin-bottom: 1.5rem;
    }
    
    .content-label {
        font-weight: 600;
        color: var(--text);
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .content-text {
        background: var(--light);
        border-radius: 8px;
        padding: 1rem;
        border: 1px solid var(--border);
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.8;
        color: var(--text);
    }
    
    .review-box {
        background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(217, 119, 6, 0.1));
        border: 2px solid #f59e0b;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
    }
    
    .review-label {
        font-weight: 700;
        color: #92400e;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem;
        background: var(--light);
        border-radius: 12px;
        color: var(--text-light);
    }
    
    @media (max-width: 768px) {
        .action-buttons {
            flex-direction: column;
        }
        
        .progress-stats {
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .score-display {
            flex-direction: column;
        }
    }

        .copy-button {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .copy-button.copied::after {
        content: '‚úì ƒê√£ copy!';
        position: absolute;
        top: -30px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--success);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        font-size: 0.85rem;
        white-space: nowrap;
        animation: fadeInOut 2s ease-in-out;
        pointer-events: none;
    }
    
    @keyframes fadeInOut {
        0% { opacity: 0; transform: translateX(-50%) translateY(5px); }
        10% { opacity: 1; transform: translateX(-50%) translateY(0); }
        90% { opacity: 1; transform: translateX(-50%) translateY(0); }
        100% { opacity: 0; transform: translateX(-50%) translateY(-5px); }
    }
    
    .copy-section {
        background: white;
        border: 2px solid var(--border);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .copy-section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .copy-section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .copy-options {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .copy-preview {
        background: var(--light);
        border-radius: 8px;
        padding: 1rem;
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border);
        white-space: pre-wrap;
        word-wrap: break-word;
        line-height: 1.8;
        color: var(--text);
        font-size: 0.95rem;
        display: none;
    }
    
    .copy-preview.show {
        display: block;
    }
    
    .copy-stats {
        display: flex;
        gap: 1.5rem;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: var(--text-light);
    }
    
    .copy-stat {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="breadcrumb">
    <a href="/">Dashboard</a>
    <span>/</span>
    <a href="{% url 'core:novel_detail' chapter.volume.novel.id %}">{{ chapter.volume.novel.title }}</a>
    <span>/</span>
    <a href="{% url 'core:volume_detail' chapter.volume.id %}">Volume {{ chapter.volume.index }}</a>
    <span>/</span>
    <span>Chapter {{ chapter.index }}</span>
</div>

<!-- Translation Style Section -->
<div class="translation-style-section">
    <div class="style-header">
        <div class="style-title">
            ‚ú® Phong c√°ch d·ªãch
        </div>
        <button onclick="toggleStyleEditor()" class="btn btn-secondary" id="editStyleBtn">
            ‚úèÔ∏è Ch·ªânh s·ª≠a
        </button>
    </div>
    
    <div id="styleDisplay" class="style-display">
        {% if chapter.volume.novel.translation_style %}
        <div class="style-content">{{ chapter.volume.novel.translation_style }}</div>
        {% else %}
        <div class="style-content empty">
            Ch∆∞a c√≥ h∆∞·ªõng d·∫´n phong c√°ch d·ªãch. Nh·∫•n "Ch·ªânh s·ª≠a" ƒë·ªÉ th√™m.
        </div>
        {% endif %}
    </div>
    
    <div id="styleEditor" class="style-editor">
        <textarea 
            id="styleTextarea" 
            class="style-textarea" 
            placeholder="Nh·∫≠p h∆∞·ªõng d·∫´n phong c√°ch d·ªãch cho AI...&#10;&#10;V√≠ d·ª•:&#10;- VƒÉn phong c·ªï trang, trang tr·ªçng&#10;- Gi·ªØ nguy√™n x∆∞ng h√¥ nh∆∞ 'Ti·ªÉu t·ª≠', 'L√£o phu'&#10;- D·ªãch t·ª± nhi√™n, d·ªÖ hi·ªÉu&#10;- Gi·ªØ t√™n ri√™ng b·∫±ng H√°n Vi·ªát"
        >{{ chapter.volume.novel.translation_style }}</textarea>
        
        <div class="style-actions">
            <button onclick="saveTranslationStyle()" class="btn btn-primary" id="saveStyleBtn">
                üíæ L∆∞u
            </button>
            <button onclick="cancelStyleEdit()" class="btn btn-secondary">
                ‚ùå H·ªßy
            </button>
        </div>
        
        <div class="style-examples">
            <div class="style-examples-title">üí° G·ª£i √Ω:</div>
            <div class="style-example">‚Ä¢ "VƒÉn phong hi·ªán ƒë·∫°i, tr·∫ª trung, d·ªÖ hi·ªÉu. Tr√°nh d√πng t·ª´ c·ªï."</div>
            <div class="style-example">‚Ä¢ "Gi·ªØ nguy√™n phong c√°ch c·ªï trang, x∆∞ng h√¥ truy·ªÅn th·ªëng (Ti·ªÉu t·ª≠, L√£o phu, Ta, Ng∆∞∆°i...)"</div>
            <div class="style-example">‚Ä¢ "D·ªãch s√°t nghƒ©a, t·ª± nhi√™n. T√™n ri√™ng d√πng H√°n Vi·ªát."</div>
            <div class="style-example">‚Ä¢ "Phong c√°ch h√†i h∆∞·ªõc, l·ªëi vƒÉn tr·∫ª, s·ª≠ d·ª•ng t·ª´ l√≥ng ph√π h·ª£p."</div>
        </div>
    </div>
</div>

<!-- Foreign Character Warning Section -->
{% if chapter.foreign_char_warning %}
<div class="foreign-warning">
    <div class="foreign-warning-header">
        <span class="foreign-warning-icon">üö®</span>
        <div>
            <div class="foreign-warning-title">Ph√°t hi·ªán k√Ω t·ª± ngo·∫°i ng·ªØ trong b·∫£n d·ªãch!</div>
            <div style="color: #dc2626; font-size: 0.9rem;">Vui l√≤ng ki·ªÉm tra v√† xem x√©t d·ªãch l·∫°i</div>
        </div>
    </div>
    <div class="foreign-warning-content">{{ chapter.foreign_char_warning }}</div>
    <div class="retranslate-hint">
        üí° <strong>G·ª£i √Ω:</strong> Nh·∫•n n√∫t "üîÑ D·ªãch l·∫°i" b√™n d∆∞·ªõi ƒë·ªÉ d·ªãch l·∫°i chapter ho·∫∑c d·ªãch l·∫°i t·ª´ng segment c√≥ v·∫•n ƒë·ªÅ.
    </div>
</div>
{% endif %}

<div class="chapter-header">
    <h1 class="chapter-title">
        üìñ {{ chapter.title_translation|default:chapter.title }}
    </h1>
    <div class="action-buttons">
        <button onclick="prepareChapter()" class="btn btn-primary" id="prepareBtn">
            üîß Chia Segments
        </button>
        
        {% if chapter.translation %}
        <button onclick="retranslateChapter()" class="btn btn-retranslate" id="retranslateBtn">
            üîÑ D·ªãch l·∫°i Chapter
        </button>
        {% else %}
        <button onclick="translateChapter()" class="btn btn-success" id="translateBtn">
            üåê D·ªãch To√†n B·ªô
        </button>
        {% endif %}
        
        <button onclick="reviewChapterAI()" class="btn btn-warning" id="reviewBtn">
            üßê Review AI
        </button>
        
        <!-- N√öT M·ªöI -->
        <a href="{% url 'core:chapter_edit' chapter.id %}" class="btn btn-primary">
            ‚úèÔ∏è Ch·ªânh S·ª≠a
        </a>
        
        <form method="post" action="{% url 'core:chapter_delete' chapter.id %}" 
            style="display: inline;"
            onsubmit="return confirm('X√≥a chapter n√†y?\n\n‚ö†Ô∏è T·∫•t c·∫£ segments v√† b·∫£n d·ªãch s·∫Ω b·ªã x√≥a!');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">
                üóëÔ∏è X√≥a Chapter
            </button>
        </form>
    </div>
</div>

{% if chapter.translation %}
<div class="copy-section">
    <div class="copy-section-header">
        <div class="copy-section-title">
            üìã Sao ch√©p b·∫£n d·ªãch
        </div>
        <div class="copy-options">
            <button onclick="copyTranslation('full')" class="btn btn-primary copy-button" id="copyFullBtn">
                üìÑ Copy To√†n B·ªô
            </button>
            <button onclick="copyTranslation('title-only')" class="btn btn-secondary copy-button" id="copyTitleBtn">
                üìå Copy Ti√™u ƒê·ªÅ
            </button>
            <button onclick="copyTranslation('content-only')" class="btn btn-secondary copy-button" id="copyContentBtn">
                üìù Copy N·ªôi Dung
            </button>
            <button onclick="togglePreview()" class="btn btn-secondary" id="previewBtn">
                üëÅÔ∏è Xem Tr∆∞·ªõc
            </button>
        </div>
    </div>
    
    <div class="copy-stats">
        <div class="copy-stat">
            <span>üìä</span>
            <span id="wordCount">{{ chapter.translation|length }}</span> k√Ω t·ª±
        </div>
        <div class="copy-stat">
            <span>üìñ</span>
            <span>{{ segments.count }}</span> segments
        </div>
        {% if chapter.match_percent %}
        <div class="copy-stat">
            <span>‚ú®</span>
            <span>{{ chapter.match_percent|floatformat:0 }}%</span> ch·∫•t l∆∞·ª£ng
        </div>
        {% endif %}
    </div>
    
    <div class="copy-preview" id="copyPreview"></div>
</div>
{% endif %}

{% if progress %}
<div class="progress-section">
    <h3 style="margin-bottom: 1rem; color: var(--dark);">üìä Ti·∫øn ƒë·ªô d·ªãch</h3>
    <div class="progress-bar">
        <div class="progress-fill" style="width: {{ progress.progress_percent }}%">
            {{ progress.progress_percent|floatformat:0 }}%
        </div>
    </div>
    <div class="progress-stats">
        <div class="stat">
            <span class="stat-label">T·ªïng segments</span>
            <span class="stat-value">{{ progress.total }}</span>
        </div>
        <div class="stat">
            <span class="stat-label">ƒê√£ d·ªãch</span>
            <span class="stat-value" style="color: var(--success);">{{ progress.translated }}</span>
        </div>
        <div class="stat">
            <span class="stat-label">C√≤n l·∫°i</span>
            <span class="stat-value" style="color: var(--warning);">{{ progress.remaining }}</span>
        </div>
    </div>
</div>
{% endif %}

{% if chapter.match_percent %}
<div class="quality-score">
    <h3 style="margin-bottom: 1rem; color: var(--dark);">üéØ Ch·∫•t l∆∞·ª£ng d·ªãch</h3>
    <div class="score-display">
        {% if chapter.match_percent >= 80 %}
            <div class="score-circle score-high">{{ chapter.match_percent|floatformat:0 }}%</div>
            <div>
                <div style="font-weight: 700; color: #065f46; font-size: 1.1rem;">‚úÖ R·∫•t ch√≠nh x√°c</div>
                <div style="color: var(--text-light); margin-top: 0.25rem;">B·∫£n d·ªãch ƒë·∫°t ch·∫•t l∆∞·ª£ng cao</div>
            </div>
        {% elif chapter.match_percent >= 50 %}
            <div class="score-circle score-medium">{{ chapter.match_percent|floatformat:0 }}%</div>
            <div>
                <div style="font-weight: 700; color: #92400e; font-size: 1.1rem;">‚ö†Ô∏è T·∫°m ·ªïn</div>
                <div style="color: var(--text-light); margin-top: 0.25rem;">C·∫ßn xem x√©t m·ªôt s·ªë ƒëo·∫°n</div>
            </div>
        {% else %}
            <div class="score-circle score-low">{{ chapter.match_percent|floatformat:0 }}%</div>
            <div>
                <div style="font-weight: 700; color: #991b1b; font-size: 1.1rem;">‚ùå C·∫ßn ch·ªânh s·ª≠a</div>
                <div style="color: var(--text-light); margin-top: 0.25rem;">B·∫£n d·ªãch c·∫ßn c·∫£i thi·ªán</div>
            </div>
        {% endif %}
    </div>
</div>
{% endif %}

<div class="segments-section">
    <h2 class="section-title">
        üìù Segments ({{ segments.count }})
    </h2>
    
    {% for segment in segments %}
    <div class="segment-card" id="segment-{{ segment.id }}" 
         data-has-warning="{% if segment.foreign_char_warning %}true{% else %}false{% endif %}">
        <div class="segment-header">
            <span class="segment-title">
                Segment {{ segment.index }}
                {% if segment.index == 1 and chapter.title_translation %}
                <span style="color: var(--primary); font-size: 0.85rem; font-weight: 500;">
                    (Ti√™u ƒë·ªÅ: {{ chapter.title_translation }})
                </span>
                {% endif %}
            </span>
            <div class="badges">
                {% if segment.translation %}
                    <span class="badge badge-success">‚úì ƒê√£ d·ªãch</span>
                    {% if segment.foreign_char_warning %}
                        <span class="badge badge-warning">
                            üö® C√≥ k√Ω t·ª± ngo·∫°i ng·ªØ
                        </span>
                    {% endif %}
                {% else %}
                    <span class="badge badge-pending">‚è≥ Ch∆∞a d·ªãch</span>
                {% endif %}
                {% if segment.match_percent %}
                    <span class="badge badge-score">{{ segment.match_percent|floatformat:0 }}%</span>
                {% endif %}
            </div>
        </div>
        
        <div class="content-block">
            <div class="content-label">üåè Nguy√™n vƒÉn</div>
            <div class="content-text">{{ segment.content_raw }}</div>
        </div>
        
        {% if segment.translation %}
        <div class="content-block translation-display">
            <div class="content-label">üáªüá≥ B·∫£n d·ªãch</div>
            <div class="content-text" id="translation-{{ segment.id }}">
                {{ segment.translation }}
            </div>
        </div>
        
        {% if segment.foreign_char_warning %}
        <div class="review-box" style="border-color: #ef4444; background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(220, 38, 38, 0.05));">
            <div class="review-label" style="color: #991b1b;">
                üö® C·∫£nh b√°o k√Ω t·ª± ngo·∫°i ng·ªØ
            </div>
            <div style="white-space: pre-line; line-height: 1.6; color: var(--text); font-family: 'Courier New', monospace; font-size: 0.9rem;">
                {{ segment.foreign_char_warning }}
            </div>
        </div>
        {% endif %}
        
        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button onclick="retranslateSegment({{ segment.id }})" class="btn btn-retranslate">
                üîÑ D·ªãch l·∫°i segment
            </button>
            {% if segment.foreign_char_warning %}
            <button onclick="highlightForeignChars({{ segment.id }})" class="btn btn-secondary" id="highlight-btn-{{ segment.id }}">
                üîç Highlight k√Ω t·ª± l·∫°
            </button>
            {% endif %}
        </div>
        {% else %}
        <button onclick="translateSegment({{ segment.id }})" class="btn btn-primary">
            üåê D·ªãch segment n√†y
        </button>
        {% endif %}
        
        {% if segment.review %}
        <div class="review-box">
            <div class="review-label">üí¨ Review AI</div>
            <div style="white-space: pre-line; line-height: 1.6; color: var(--text);">{{ segment.review }}</div>
        </div>
        {% endif %}
    </div>
    {% empty %}
    <div class="empty-state">
        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
        <div>Ch∆∞a c√≥ segments. Nh·∫•n "Chia Segments" ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>
    </div>
    {% endfor %}
</div>

<script>
const chapterId = {{ chapter.id }};
const novelId = {{ chapter.volume.novel.id }};

async function copyTranslation(type) {
    const titleTranslation = `{{ chapter.title_translation|default:chapter.title|escapejs }}`;
    const contentTranslation = `{{ chapter.translation|escapejs }}`;
    
    let textToCopy = '';
    let buttonId = '';
    
    switch(type) {
        case 'full':
            textToCopy = `${titleTranslation}\n\n${contentTranslation}`;
            buttonId = 'copyFullBtn';
            break;
        case 'title-only':
            textToCopy = titleTranslation;
            buttonId = 'copyTitleBtn';
            break;
        case 'content-only':
            textToCopy = contentTranslation;
            buttonId = 'copyContentBtn';
            break;
    }
    
    try {
        await navigator.clipboard.writeText(textToCopy);
        showCopySuccess(buttonId);
    } catch (err) {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(textToCopy, buttonId);
    }
}

function showCopySuccess(buttonId) {
    const button = document.getElementById(buttonId);
    button.classList.add('copied');
    
    setTimeout(() => {
        button.classList.remove('copied');
    }, 2000);
}

function fallbackCopyTextToClipboard(text, buttonId) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.top = "-9999px";
    textArea.style.left = "-9999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        document.execCommand('copy');
        showCopySuccess(buttonId);
    } catch (err) {
        alert('‚ùå Kh√¥ng th·ªÉ copy. Vui l√≤ng th·ª≠ l·∫°i.');
    }
    
    document.body.removeChild(textArea);
}

function togglePreview() {
    const preview = document.getElementById('copyPreview');
    const btn = document.getElementById('previewBtn');
    
    if (preview.classList.contains('show')) {
        preview.classList.remove('show');
        btn.textContent = 'üëÅÔ∏è Xem Tr∆∞·ªõc';
    } else {
        const titleTranslation = `{{ chapter.title_translation|default:chapter.title|escapejs }}`;
        const contentTranslation = `{{ chapter.translation|escapejs }}`;
        preview.textContent = `${titleTranslation}\n\n${contentTranslation}`;
        preview.classList.add('show');
        btn.textContent = 'üôà ·∫®n';
    }
}

function getCookie(name) {
    let value = "; " + document.cookie;
    let parts = value.split("; " + name + "=");
    if (parts.length === 2) return parts.pop().split(";").shift();
}

// Translation Style Functions
function toggleStyleEditor() {
    const editor = document.getElementById('styleEditor');
    const display = document.getElementById('styleDisplay');
    const btn = document.getElementById('editStyleBtn');
    
    if (editor.classList.contains('show')) {
        editor.classList.remove('show');
        display.style.display = 'block';
        btn.textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a';
    } else {
        editor.classList.add('show');
        display.style.display = 'none';
        btn.textContent = 'üëÅÔ∏è Xem';
        document.getElementById('styleTextarea').focus();
    }
}

function cancelStyleEdit() {
    document.getElementById('styleEditor').classList.remove('show');
    document.getElementById('styleDisplay').style.display = 'block';
    document.getElementById('editStyleBtn').textContent = '‚úèÔ∏è Ch·ªânh s·ª≠a';
}

async function saveTranslationStyle() {
    const textarea = document.getElementById('styleTextarea');
    const style = textarea.value.trim();
    const btn = document.getElementById('saveStyleBtn');
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ƒêang l∆∞u...';
    
    try {
        const response = await fetch(`/novel/${novelId}/update-translation-style/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ translation_style: style })
        });
        
        const data = await response.json();
        
        if (data.ok) {
            // Update display
            const displayDiv = document.querySelector('.style-content');
            if (style) {
                displayDiv.textContent = style;
                displayDiv.classList.remove('empty');
            } else {
                displayDiv.textContent = 'Ch∆∞a c√≥ h∆∞·ªõng d·∫´n phong c√°ch d·ªãch. Nh·∫•n "Ch·ªânh s·ª≠a" ƒë·ªÉ th√™m.';
                displayDiv.classList.add('empty');
            }
            
            cancelStyleEdit();
            alert('‚úÖ ƒê√£ l∆∞u phong c√°ch d·ªãch!');
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üíæ L∆∞u';
    }
}

async function prepareChapter() {
    const btn = document.getElementById('prepareBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ƒêang chia...';
    
    try {
        const response = await fetch(`/chapter/${chapterId}/prepare/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });
        const data = await response.json();
        
        if (data.ok) {
            alert(data.message);
            location.reload();
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîß Chia Segments';
    }
}

async function translateSegment(segmentId) {
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ƒêang d·ªãch...';
    
    try {
        const response = await fetch(`/segment/${segmentId}/translate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });
        const data = await response.json();
        
        if (data.ok) {
            location.reload();
        } else {
            alert('L·ªói: ' + data.error);
            btn.disabled = false;
            btn.innerHTML = 'üåê D·ªãch segment n√†y';
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error);
        btn.disabled = false;
        btn.innerHTML = 'üåê D·ªãch segment n√†y';
    }
}

async function translateChapter() {
    const btn = document.getElementById('translateBtn');
    if (!confirm('D·ªãch to√†n b·ªô chapter? Qu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.')) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ƒêang d·ªãch...';
    
    try {
        const response = await fetch(`/chapter/${chapterId}/translate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });
        const data = await response.json();
        
        if (data.ok) {
            let msg = `‚úÖ ${data.message}`;
            if (data.has_foreign_warning) {
                msg += `\n\n‚ö†Ô∏è C·∫£nh b√°o: Ph√°t hi·ªán ${data.foreign_warnings.length} segment c√≥ k√Ω t·ª± ngo·∫°i ng·ªØ!`;
            }
            alert(msg);
            location.reload();
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üåê D·ªãch To√†n B·ªô';
    }
}

async function retranslateSegment(segmentId) {
    if (!confirm('D·ªãch l·∫°i segment n√†y? B·∫£n d·ªãch c≈© s·∫Ω b·ªã ghi ƒë√®.')) {
        return;
    }
    
    const btn = event.target;
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ƒêang d·ªãch l·∫°i...';
    
    try {
        const response = await fetch(`/segment/${segmentId}/retranslate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });
        const data = await response.json();
        
        if (data.ok) {
            location.reload();
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ D·ªãch l·∫°i segment';
    }
}

async function retranslateChapter() {
    if (!confirm('D·ªãch l·∫°i to√†n b·ªô chapter? T·∫•t c·∫£ b·∫£n d·ªãch c≈© s·∫Ω b·ªã ghi ƒë√®.\n\nQu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t.')) {
        return;
    }
    
    const btn = document.getElementById('retranslateBtn');
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ƒêang d·ªãch l·∫°i...';
    
    try {
        const response = await fetch(`/chapter/${chapterId}/retranslate/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });
        const data = await response.json();
        
        if (data.ok) {
            let msg = `‚úÖ D·ªãch l·∫°i th√†nh c√¥ng!\n\n${data.message}`;
            if (data.has_foreign_warning) {
                msg += `\n\n‚ö†Ô∏è V·∫´n ph√°t hi·ªán ${data.foreign_warnings.length} segment c√≥ k√Ω t·ª± ngo·∫°i ng·ªØ`;
            }
            alert(msg);
            location.reload();
        } else {
            alert('L·ªói: ' + data.error);
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üîÑ D·ªãch l·∫°i Chapter';
    }
}

async function highlightForeignChars(segmentId) {
    const translationDiv = document.getElementById(`translation-${segmentId}`);
    const btn = document.getElementById(`highlight-btn-${segmentId}`);
    
    if (!translationDiv) return;
    
    try {
        const response = await fetch(`/segment/${segmentId}/highlight-foreign/`);
        const data = await response.json();
        
        if (data.ok) {
            // Toggle between normal and highlighted
            if (translationDiv.dataset.highlighted === 'true') {
                translationDiv.innerHTML = data.original_text;
                translationDiv.dataset.highlighted = 'false';
                btn.textContent = 'üîç Highlight k√Ω t·ª± l·∫°';
            } else {
                translationDiv.innerHTML = data.highlighted_html;
                translationDiv.dataset.highlighted = 'true';
                btn.textContent = 'üëÅÔ∏è Xem b√¨nh th∆∞·ªùng';
            }
        }
    } catch (error) {
        console.error('Error highlighting:', error);
    }
}

async function reviewChapterAI() {
    const btn = document.getElementById('reviewBtn');
    if (!confirm('Review AI ch·∫•t l∆∞·ª£ng d·ªãch? Qu√° tr√¨nh n√†y s·∫Ω ƒë√°nh gi√° t·ª´ng segment.')) {
        return;
    }
    
    btn.disabled = true;
    btn.innerHTML = '<span class="loading"></span> ƒêang review...';
    
    try {
        const response = await fetch(`/chapter/${chapterId}/review/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            }
        });
        
        if (response.ok) {
            alert('‚úÖ Review ho√†n t·∫•t!');
            location.reload();
        } else {
            alert('L·ªói khi review');
        }
    } catch (error) {
        alert('L·ªói k·∫øt n·ªëi: ' + error);
    } finally {
        btn.disabled = false;
        btn.innerHTML = 'üßê Review AI';
    }
}
</script>
{% endblock %}